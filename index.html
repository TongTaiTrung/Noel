<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>2 Months of Us | Forever Together</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      :root {
        --bg-color: #ffe6e9;
        --primary-color: #ff8fa3;
        --accent-color: #ff4d6d;
        --text-color: #594a4e;
        --card-bg: rgba(255, 255, 255, 0.75);
        --font-heading: "Dancing Script", cursive;
        --font-body: "Quicksand", sans-serif;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        background: linear-gradient(-45deg, #fff0f3, #ffe6e9, #fff0f5, #ffd1dc);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        font-family: var(--font-body);
        color: var(--text-color);
        overflow-x: hidden;
        user-select: none;
        -webkit-overflow-scrolling: touch;
      }

      @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      /* --- SCROLL PROGRESS --- */
      .scroll-progress {
        position: fixed; top: 0; left: 0; height: 5px;
        background: linear-gradient(to right, var(--primary-color), var(--accent-color));
        width: 0%; z-index: 100001;
        box-shadow: 0 0 15px rgba(255, 77, 109, 0.5);
      }

      /* --- BACKGROUND ELEMENTS --- */
      .background-container {
        position: fixed; inset: 0; z-index: -2; overflow: hidden; pointer-events: none;
      }
      .blob {
        position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.6; 
        will-change: transform;
      }
      
      .bg-heart {
        position: absolute; color: var(--primary-color); opacity: 0; z-index: -1; filter: blur(1px);
      }

      /* --- CURSOR (PC Only) --- */
      @media (pointer: fine) {
        * { cursor: none !important; }
        .cursor-dot, .cursor-outline {
          position: fixed; top: 0; left: 0; transform: translate(-50%, -50%);
          border-radius: 50%; z-index: 1000000000; pointer-events: none; will-change: transform;
        }
        .cursor-dot { width: 8px; height: 8px; background-color: var(--accent-color); }
        .cursor-outline {
          width: 40px; height: 40px; border: 2px solid var(--primary-color);
          transition: width 0.3s, height 0.3s, background 0.3s;
        }
      }
      @media (pointer: coarse) {
        .cursor-dot, .cursor-outline { display: none; }
      }

      /* --- UI ELEMENTS --- */
      .music-btn {
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        background: var(--card-bg); border: 2px solid var(--primary-color);
        border-radius: 50%; width: 50px; height: 50px;
        display: flex; justify-content: center; align-items: center;
        color: var(--accent-color); box-shadow: 0 8px 20px rgba(255, 143, 163, 0.3);
        backdrop-filter: blur(10px); cursor: pointer;
        transition: transform 0.3s;
      }
      .music-btn:active { transform: scale(0.9); }
      .music-anim { animation: spin 4s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }

      section {
        min-height: 100vh; display: flex; flex-direction: column;
        justify-content: center; align-items: center; padding: 2rem; position: relative;
      }

      /* --- HERO SECTION --- */
      .ml11 {
        font-family: var(--font-heading); font-size: clamp(2.5rem, 8vw, 5.5rem);
        color: var(--accent-color); overflow: hidden; text-align: center;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      }
      .typewriter-cursor {
        display: inline-block; animation: blink 1s step-end infinite;
      }
      .typewriter-cursor.hidden { display: none; }
      @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

      .subtitle {
        font-size: clamp(1rem, 4vw, 1.5rem); margin-top: 20px; font-weight: 600;
        background: linear-gradient(45deg, #ff8fa3, #ff4d6d);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        text-align: center; min-height: 1.5em;
      }

      /* --- STORY CARD --- */
      .story-section { perspective: 1500px; }
      .story-card {
        background: var(--card-bg);
        padding: clamp(2rem, 5vw, 4rem); border-radius: 40px;
        backdrop-filter: blur(20px);
        box-shadow: 0 30px 60px rgba(255, 143, 163, 0.2);
        max-width: 800px; width: 100%;
        border: 1px solid rgba(255, 255, 255, 0.5);
        transform-style: preserve-3d;
        transform-origin: center top; 
        will-change: transform, opacity;
        opacity: 0;
        transform: translateY(50px);
      }
      
      @media (max-width: 768px) {
          .story-card {
              transition: transform 0.6s ease-out, opacity 0.6s ease-out;
          }
      }

      @media (min-width: 769px) {
        .story-card { transform: rotateX(-90deg); }
      }
      
      .story-line {
        display: block; margin-bottom: 15px; font-size: 1.2rem;
        opacity: 0; transform: translateY(20px);
        will-change: transform, opacity;
      }

      /* --- GALLERY --- */
      .memory-section { padding-top: 4rem; padding-bottom: 4rem; }
      .gallery-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2.5rem; width: 100%; max-width: 1200px;
      }
      .memory-card {
        background: #fff; padding: 12px 12px 55px 12px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        border-radius: 4px; opacity: 0; 
        cursor: pointer; 
        transition: box-shadow 0.3s ease;
        position: relative;
        will-change: transform;
      }
      @keyframes floatIdle {
        0%, 100% { transform: translateY(0) rotate(var(--r, 0deg)); }
        50% { transform: translateY(-10px) rotate(var(--r, 0deg)); }
      }
      .memory-card.animate-idle { animation: floatIdle 4s ease-in-out infinite; }
      .memory-card:nth-child(2n) { animation-delay: 0.5s; }
      .memory-card:nth-child(3n) { animation-delay: 1s; }
      .memory-card:nth-child(5n) { animation-delay: 1.5s; }
      .memory-card:hover { z-index: 10; box-shadow: 0 25px 45px rgba(255, 77, 109, 0.3); }
      .card-image {
        width: 100%; height: 300px; object-fit: cover; border-radius: 2px;
        background: #f0f0f0;
      }
      .caption-text {
        position: absolute; bottom: 15px; left: 0; width: 100%;
        text-align: center; font-family: "Dancing Script", cursive;
        font-size: 1.8rem; color: #555;
      }

      /* --- COUNTER --- */
      .counter-box {
        background: var(--card-bg); backdrop-filter: blur(15px);
        width: clamp(280px, 80vw, 380px); height: clamp(280px, 80vw, 380px);
        border-radius: 50%; display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        border: 2px dashed var(--primary-color);
        box-shadow: 0 0 50px rgba(255, 143, 163, 0.2);
        will-change: transform;
      }
      #days-count { font-size: clamp(4rem, 12vw, 7rem); font-weight: 700; color: var(--accent-color); }

      /* --- FINAL --- */
      .heart-btn {
        font-size: clamp(4rem, 10vw, 6rem); background: none; border: none;
        filter: drop-shadow(0 0 15px rgba(255, 77, 109, 0.4));
        animation: heartbeat 1.5s infinite; cursor: pointer; z-index: 100;
      }
      @keyframes heartbeat {
        0%, 100% { transform: scale(1); } 50% { transform: scale(1.2) rotate(5deg); }
      }

      /* --- POLAROID MODAL STYLES --- */
      .modal {
        position: fixed; inset: 0; display: flex; justify-content: center;
        align-items: center; z-index: 100002; 
        pointer-events: none; opacity: 0;
      }
      
      .modal-overlay {
        position: absolute; inset: 0; background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(5px);
        opacity: 0;
      }

      .modal-content {
        position: relative;
        background: #fff;
        padding: 15px;
        border-radius: 4px;
        width: 90%; max-width: 500px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        transform-origin: center center;
        opacity: 0;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }
      
      .modal-content::before {
        content: ''; position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
        width: 100px; height: 35px;
        background-color: rgba(255, 255, 255, 0.3);
        border-left: 1px dashed rgba(0,0,0,0.1);
        border-right: 1px dashed rgba(0,0,0,0.1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        backdrop-filter: blur(2px);
        z-index: 2;
      }

      .modal-inner {
        width: 100%; overflow: hidden;
        border: 1px solid #eee;
        flex-shrink: 0;
        display: flex; justify-content: center; align-items: center;
        background: #f8f8f8;
      }

      #modal-img {
        width: 100%; height: auto; max-height: 55vh; object-fit: contain; display: block;
      }
      
      .modal-caption-container {
        position: relative; width: 100%; padding-top: 15px; padding-bottom: 10px; text-align: center;
        min-height: 60px;
      }

      #modal-caption {
        font-family: 'Dancing Script', cursive; 
        color: #444; 
        font-size: clamp(1.5rem, 5vw, 2rem);
        line-height: 1.3;
        word-wrap: break-word;
        display: inline; 
      }

      .modal-cursor {
        display: inline-block;
        width: 2px; height: 1.2em;
        background-color: var(--accent-color);
        margin-left: 2px;
        animation: blink 1s step-end infinite;
        vertical-align: middle;
      }
      
      .close-modal {
        position: absolute; top: -15px; right: -15px; width: 40px; height: 40px;
        background: var(--accent-color); color: white; border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        font-size: 1.2rem; z-index: 10;
        border: 3px solid white;
        transition: transform 0.3s;
      }
      .close-modal:hover { transform: scale(1.1) rotate(90deg); }

      /* --- SPARK EFFECT STYLE --- */
      .spark {
        position: fixed;
        width: 4px; height: 4px;
        border-radius: 50%;
        pointer-events: none;
        z-index: 999999;
      }

      .particle {
        position: fixed; pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff4d6d'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
        background-size: contain; width: 25px; height: 25px; z-index: 10000;
      }

      @media (max-width: 768px) {
        .background-container .blob { filter: blur(40px); opacity: 0.4; }
        .caption-text { font-size: 1.5rem; }
        .modal-content { width: 85%; }
      }
    </style>
  </head>
  <body>
    <div class="scroll-progress" id="scroll-progress"></div>
    <div class="cursor-dot"></div>
    <div class="cursor-outline"></div>

    <button class="music-btn" id="music-toggle" onclick="toggleMusic()">
      <i class="fas fa-music"></i>
    </button>
    <audio id="bg-music" loop>
      <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mp3" />
    </audio>

    <div class="background-container" id="bg-container">
      <div class="blob" id="blob1" style="background: #ffc2d1; width: 40vw; height: 40vw; top: 5%; left: -10%;"></div>
      <div class="blob" id="blob2" style="background: #ffe5ec; width: 50vw; height: 50vw; top: 40%; right: -15%;"></div>
      <div class="blob" id="blob3" style="background: #ffccd5; width: 35vw; height: 35vw; bottom: 0%; left: 15%;"></div>
      <div id="hearts-container"></div>
    </div>

    <section class="hero-section">
      <h1 class="ml11" id="typewriter-title">
        <span class="typewriter-text"></span>
        <span class="typewriter-cursor">|</span>
      </h1>
      <p class="subtitle" id="typewriter-subtitle">
        <span class="subtitle-text"></span>
        <span class="typewriter-cursor hidden">|</span>
      </p>
      <div class="scroll-indicator" style="margin-top: 40px; animation: bounce 2s infinite">
        <i class="fas fa-chevron-down" style="font-size: 2rem; color: var(--accent-color)"></i>
      </div>
    </section>

    <section class="story-section" id="story">
      <div class="story-card">
        <h2 style="text-align: center; margin-bottom: 20px; font-family: var(--font-heading); font-size: 2.5rem; color: var(--accent-color);">C√¢u chuy·ªán nh·ªè</h2>
        <div class="story-content">
          <span class="story-line">Hai th√°ng tr√¥i qua th·∫≠t nhanh,</span>
          <span class="story-line">nh∆∞ng c≈©ng ƒë·ªß ƒë·ªÉ ch√∫ng ta c√≥ nh·ªØng k·ª∑ ni·ªám th·∫≠t ƒë·∫πp.</span>
          <span class="story-line">T·ª´ nh·ªØng d√≤ng tin nh·∫Øn ƒë·∫ßu ti√™n,</span>
          <span class="story-line">nh·ªØng bu·ªïi h·∫πn h√≤ ng·∫°i ng√πng cho ƒë·∫øn l√∫c n√†y.</span>
          <span class="story-line">M·ªói ng√†y tr√¥i qua, anh l·∫°i th·∫•y y√™u em nhi·ªÅu h∆°n.</span>
        </div>
      </div>
    </section>

    <section class="memory-section" id="gallery">
      <h2
        class="gallery-title"
        style="text-align:center; font-family: 'Dancing Script'; font-size: 3rem; color: #ff4d6d; margin-bottom: 2rem; opacity: 0;"
      >
        Kho·∫£nh kh·∫Øc c·ªßa ch√∫ng ta
      </h2>
      <div class="gallery-grid" id="gallery-grid"></div>
    </section>

    <section class="counter-section" id="counter">
      <div class="counter-box">
        <h3 style="font-size: 1.1rem; color: #888; text-transform: uppercase; margin-top: 20px;">
          Ch√∫ng ta ƒë√£ b√™n nhau
        </h3>
        <div class="number-wrapper">
          <span id="days-count">0</span>
        </div>
        <span class="label" style="font-size: 1.5rem; color: #ff4d6d; font-weight: 600; margin-bottom: 20px;"
          >Ng√†y h·∫°nh ph√∫c</span
        >
      </div>
    </section>

    <section id="final">
      <p
        class="final-text"
        style="font-size: 1.8rem; margin-bottom: 20px; font-weight: 700; font-family: var(--font-heading); opacity: 0; text-align: center;"
      >
        Y√™u em m√£i m√£i!
      </p>
      <button id="heart-btn" class="heart-btn" style="opacity: 0">
        <i class="fas fa-heart" style="color: #ff4d6d"></i>
      </button>
      <p class="click-hint" style="font-size: 0.9rem; color: #999; margin-top:10px; opacity:0">
        (Nh·∫•n v√†o tim nh√©)
      </p>
    </section>

    <div class="modal" id="image-modal">
      <div class="modal-overlay" onclick="closeModal()"></div>
      <div class="modal-content">
        <div class="close-modal" onclick="closeModal()"><i class="fas fa-times"></i></div>
        <div class="modal-inner">
            <img src="" id="modal-img" alt="Memory Detail"/>
        </div>
        <div class="modal-caption-container">
            <span id="modal-caption"></span><span class="modal-cursor"></span>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <script>
      // CONFIGURATION & VARIABLES
      const startDate = new Date(2025, 9, 26); 
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
      let rafId = null;

      // Memories Data (GI·ªÆ NGUY√äN)
      const memories = [
        { id: 1, img: "/textures/img7.jpg", caption: "T·∫•m h√¨nh k·ª∑ ni·ªám ƒë·∫ßu ti√™n c·ªßa hai m√¨nh.", date: "21/10/2025" },
        { id: 2, img: "/textures/img1.jpg", caption: "Nh·ªØng ng√†y khi ch√∫ng ta c√≤n b·ª° ng·ª° khi b·∫Øt chuy·ªán v·ªõi nhau.", date: "22/10/2025" },
        { id: 3, img: "/textures/img6.jpg", caption: "L√∫c ra v·ªÅ nh∆∞ng l·∫°i kh√¥ng mu·ªën r·ªùi xa em.", date: "25/10/2025" },
        { id: 4, img: "/textures/img4.jpg", caption: "Bu·ªïi ƒëi ch∆°i gi·ªëng nh∆∞ h·∫πn h√≤ v·∫≠y, anh c·ª© nh·ªõ m√£i.", date: "14/11/2025" },
        { id: 5, img: "/textures/img8.jpg", caption: "M√≥n qu√† em t·∫∑ng anh nh√¢n ng√†y International Men's Day.", date: "19/11/2025" },
        { id: 6, img: "/textures/img9.png", caption: "Em l·∫°i ƒë·∫øn b√™n anh v·ªõi m·ªôt b·∫•t ng·ªù. C√≥ l·∫Ω tr∆∞·ªõc ƒë√≥ anh ƒë√£ kh√¥ng n√≥i, nh∆∞ng m√≥n qu√† c·ªßa em khi·∫øn anh x√∫c ƒë·ªông r·∫•t nhi·ªÅu!", date: "19/11/2025" },
        { id: 7, img: "/textures/img2.jpg", caption: "M·ªói gi√¢y ph√∫t b√™n em, ƒë·ªëi v·ªõi anh ƒë√≥ ƒë·ªÅu l√† nh·ªØng m√≥n qu√†.", date: "20/11/2025" },
      ];

      // --- INITIALIZATION ---
      const galleryGrid = document.getElementById("gallery-grid");
      galleryGrid.innerHTML = memories.map((m) => {
            const safeCaption = m.caption.replace(/'/g, "\\'");
            return `
            <div class="memory-card" onclick="openModal('${m.img}', '${safeCaption}')">
              <img src="${m.img}" class="card-image" alt="Memory" loading="lazy">
              <div class="caption-text">${m.date}</div>
            </div>
          `;
        }).join("");

      // --- SPARK EFFECT FUNCTION ---
      // H√†m t·∫°o tia l·ª≠a ngay t·∫°i v·ªã tr√≠ con tr·ªè
      function createTyperSpark(element) {
        if (!element) return;
        const rect = element.getBoundingClientRect();
        // L·∫•y v·ªã tr√≠ t√¢m c·ªßa con tr·ªè
        const x = rect.left + rect.width / 2;
        const y = rect.top + rect.height / 2;

        // T·∫°o 1-2 h·∫°t tia l·ª≠a
        for (let i = 0; i < 2; i++) {
            const spark = document.createElement('div');
            spark.classList.add('spark');
            spark.style.left = x + 'px';
            spark.style.top = y + 'px';
            spark.style.backgroundColor = isMobile ? '#ff4d6d' : (i % 2 === 0 ? '#ffeb3b' : '#ff4d6d'); // M√†u v√†ng ho·∫∑c h·ªìng
            document.body.appendChild(spark);

            anime({
                targets: spark,
                translateX: () => anime.random(-15, 15),
                translateY: () => anime.random(-15, 15),
                scale: [1, 0],
                opacity: [1, 0],
                duration: anime.random(300, 500),
                easing: 'easeOutExpo',
                complete: () => spark.remove()
            });
        }
      }

      // --- MODAL WITH TYPEWRITER (NO SHAKE, ADD SPARKS) ---
      const modalEl = document.getElementById('image-modal');
      const modalOverlay = document.querySelector('.modal-overlay');
      const modalContent = document.querySelector('.modal-content');
      const modalImg = document.getElementById('modal-img');
      const modalCaption = document.getElementById('modal-caption');
      
      let typeInterval; 

      function openModal(imgSrc, captionText) {
        modalImg.src = imgSrc;
        modalCaption.innerText = ""; 
        
        modalEl.style.opacity = 1;
        modalEl.style.pointerEvents = 'auto';
        
        const randomRotate = anime.random(-4, 4);

        anime.timeline({ easing: 'easeOutExpo', duration: 800 })
        .add({
            targets: modalOverlay,
            opacity: [0, 1],
            duration: 400
        })
        .add({
            targets: modalContent,
            scale: [0.6, 1],
            opacity: [0, 1],
            rotate: [`${randomRotate*3}deg`, `${randomRotate}deg`], 
            translateY: [-50, 0],
            translateX: 0,
            easing: 'spring(1, 80, 10, 0)', 
        }, '-=200');

        clearInterval(typeInterval);
        
        // B·∫Øt ƒë·∫ßu g√µ ch·ªØ
        setTimeout(() => {
            let i = 0;
            typeInterval = setInterval(() => {
                if (i < captionText.length) {
                    modalCaption.textContent += captionText.charAt(i);
                    i++;
                    
                    // K√çCH HO·∫†T TIA L·ª¨A T·∫†I CON TR·ªé MODAL
                    const cursor = document.querySelector('.modal-cursor');
                    createTyperSpark(cursor);

                } else {
                    clearInterval(typeInterval);
                }
            }, 30);
        }, 500);
      }

      function closeModal() {
        clearInterval(typeInterval);
        const tl = anime.timeline({
            easing: 'easeInBack',
            duration: 400,
            complete: () => {
                modalEl.style.pointerEvents = 'none';
                setTimeout(() => { modalImg.src = ""; }, 100);
            }
        });

        tl
        .add({
            targets: modalContent,
            scale: 0.8,
            opacity: 0,
            translateY: 50 
        })
        .add({
            targets: modalOverlay,
            opacity: 0
        }, '-=200');
      }

      // --- FLOATING HEARTS BACKGROUND ---
      function createFloatingHearts() {
        const container = document.getElementById('hearts-container');
        const heartCount = isMobile ? 15 : 30;

        for (let i = 0; i < heartCount; i++) {
            const heart = document.createElement('div');
            heart.classList.add('bg-heart', 'fas', 'fa-heart');
            
            const size = Math.random() * 20 + 10;
            heart.style.fontSize = `${size}px`;
            heart.style.left = `${Math.random() * 100}vw`;
            heart.style.top = `${Math.random() * 100 + 100}vh`; 
            
            container.appendChild(heart);

            anime({
                targets: heart,
                translateY: function() { return -1 * (Math.random() * 1000 + 800) },
                translateX: function() { return anime.random(-50, 50); },
                opacity: [
                    { value: 0.6, duration: 100 },
                    { value: 0, duration: 2000, delay: 3000 }
                ],
                rotate: function() { return anime.random(-45, 45); },
                duration: function() { return anime.random(5000, 10000); },
                delay: function() { return anime.random(0, 5000); },
                loop: true,
                easing: 'linear'
            });
        }
      }
      createFloatingHearts();

      // --- TYPEWRITER (HERO SECTION WITH SPARKS) ---
      function typeWriter(element, text, speed, callback, cursorElement) {
        let i = 0;
        element.textContent = "";
        if (cursorElement) cursorElement.classList.remove("hidden");
        function type() {
          if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            // K√çCH HO·∫†T TIA L·ª¨A T·∫†I CON TR·ªé HERO
            createTyperSpark(cursorElement);
            setTimeout(type, speed);
          } else {
            if (callback) callback();
          }
        }
        type();
      }

      function eraseText(element, callback, cursorElement) {
        const text = element.textContent;
        let i = text.length;
        function erase() {
          if (i > 0) {
            element.textContent = text.substring(0, i - 1);
            i--;
            setTimeout(erase, 30);
          } else {
            if (callback) callback();
          }
        }
        erase();
      }

      const titleText = "Happy 2 Months Anniversary";
      const titleElement = document.querySelector("#typewriter-title .typewriter-text");
      const titleCursor = document.querySelector("#typewriter-title .typewriter-cursor");
      
      const loveMessages = [
        "C·∫£m ∆°n v√¨ ƒë√£ ƒë·∫øn b√™n anh ‚ù§Ô∏è",
        "M·ªói ng√†y b√™n em ƒë·ªÅu l√† m·ªôt m√≥n qu√† üíï",
        "Anh y√™u em nhi·ªÅu h∆°n em bi·∫øt üåπ",
        "Em l√† ƒëi·ªÅu tuy·ªát v·ªùi nh·∫•t ‚ú®"
      ];
      let msgIndex = 0;

      typeWriter(titleElement, titleText, 100, () => {
        setTimeout(() => {
            titleCursor.classList.add('hidden');
            startSubtitleLoop();
        }, 1000);
      }, titleCursor);

      function startSubtitleLoop() {
        const subEl = document.querySelector("#typewriter-subtitle .subtitle-text");
        const subCur = document.querySelector("#typewriter-subtitle .typewriter-cursor");
        
        function loop() {
            if(msgIndex >= loveMessages.length) msgIndex = 0;
            const msg = loveMessages[msgIndex];
            subCur.classList.remove('hidden');
            typeWriter(subEl, msg, 80, () => {
                setTimeout(() => {
                    eraseText(subEl, () => {
                        msgIndex++;
                        loop();
                    }, subCur);
                }, 2000);
            }, subCur);
        }
        loop();
      }

      // --- SCROLL EFFECTS ---
      const blob1 = document.getElementById("blob1");
      const blob2 = document.getElementById("blob2");
      const storySection = document.getElementById("story");
      const storyCard = document.querySelector(".story-card");
      const storyLines = document.querySelectorAll(".story-line");
      const progressBar = document.getElementById("scroll-progress");

      function handleScrollEffects() {
        const scrollY = window.scrollY;
        const windowHeight = window.innerHeight;
        
        const docHeight = document.body.scrollHeight - windowHeight;
        if(docHeight > 0) {
            const progress = (scrollY / docHeight) * 100;
            progressBar.style.width = `${progress}%`;
        }
        
        const factor = isMobile ? 0.05 : 0.2;
        blob1.style.transform = `translate3d(0, ${scrollY * factor}px, 0)`;
        blob2.style.transform = `translate3d(0, ${scrollY * -factor}px, 0)`;

        if (storySection && storyCard) {
            const rect = storySection.getBoundingClientRect();
            let fraction = (windowHeight - rect.top) / (windowHeight + rect.height);
            fraction = Math.max(0, Math.min(1, fraction));

            if (!isMobile) {
                let rotation, opacity, translateY;
                if (fraction <= 0.5) {
                    const progress = fraction * 2; 
                    rotation = -90 + (90 * progress);
                    opacity = progress;
                    translateY = 50 * (1 - progress);
                } else {
                    const progress = (fraction - 0.5) * 2;
                    rotation = 0 + (90 * progress);
                    opacity = 1 - progress; 
                    translateY = -50 * progress;
                }
                storyCard.style.transform = `rotateX(${rotation}deg) translate3d(0, ${translateY}px, 0)`;
                storyCard.style.opacity = Math.min(1, opacity + 0.2); 
            } else {
                if (fraction > 0.05 && fraction < 1.1) {
                    storyCard.style.opacity = 1;
                    storyCard.style.transform = "translateY(0)";
                } else {
                    storyCard.style.opacity = 0;
                    storyCard.style.transform = "translateY(50px)";
                }
            }

            storyLines.forEach((line, index) => {
                const triggerPoint = 0.2 + (index * 0.05);
                if (fraction > triggerPoint) {
                    line.style.opacity = 1;
                    line.style.transform = `translate3d(0, 0, 0)`;
                    line.style.transition = "all 0.5s ease";
                } else {
                    line.style.opacity = 0;
                    line.style.transform = `translate3d(0, 20px, 0)`;
                }
            });
        }
        rafId = null;
      }

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if(entry.isIntersecting) {
                if(entry.target.id === "gallery") {
                    anime({
                        targets: '.gallery-title', opacity: [0,1], translateY: [-20,0], duration: 800, easing: 'easeOutQuad'
                    });
                    
                    anime({
                        targets: '.memory-card', 
                        opacity: [0,1], 
                        translateY: [50,0], 
                        rotate: function() { return anime.random(-3, 3); }, 
                        delay: anime.stagger(150), 
                        easing: 'easeOutQuad',
                        complete: function(anim) {
                            document.querySelectorAll('.memory-card').forEach(card => {
                                const currentRotation = card.style.transform.match(/rotate\(([^)]+)\)/);
                                const rot = currentRotation ? currentRotation[1] : '0deg';
                                card.style.setProperty('--r', rot);
                                card.classList.add('animate-idle');
                                card.style.transform = ''; 
                            });
                        }
                    });
                    observer.unobserve(entry.target);
                }
                if(entry.target.id === "counter") {
                    const today = new Date();
                    const diff = Math.ceil(Math.abs(today - startDate) / (1000 * 60 * 60 * 24));
                    anime({
                        targets: '#days-count', innerHTML: [0, diff], round: 1, duration: 2000, easing: 'easeOutExpo'
                    });
                    observer.unobserve(entry.target);
                }
                if(entry.target.id === "final") {
                    anime({ targets: '.final-text', opacity: [0,1], translateY: [20,0], duration: 800 });
                    anime({ targets: '#heart-btn', opacity: [0,1], scale: [0,1], delay: 300, duration: 1000 });
                    anime({ targets: '.click-hint', opacity: [0,1], delay: 800, duration: 800 });
                    observer.unobserve(entry.target);
                }
            }
        });
      }, { threshold: 0.15 });

      document.querySelectorAll('#gallery, #counter, #final').forEach(sec => observer.observe(sec));

      window.addEventListener('scroll', () => {
        if (!rafId) {
            rafId = requestAnimationFrame(handleScrollEffects);
        }
      }, { passive: true });
      
      handleScrollEffects();

      if (!isMobile) {
        const dot = document.querySelector(".cursor-dot");
        const outline = document.querySelector(".cursor-outline");
        window.addEventListener("mousemove", (e) => {
            dot.style.left = e.clientX + "px"; dot.style.top = e.clientY + "px";
            outline.animate({
                left: `${e.clientX}px`,
                top: `${e.clientY}px`
            }, { duration: 500, fill: "forwards" });
        });
      }

      let isPlaying = false;
      function toggleMusic() {
        const audio = document.getElementById("bg-music");
        const btn = document.getElementById("music-toggle");
        if(isPlaying) { 
            audio.pause(); 
            btn.classList.remove("music-anim"); 
        } else { 
            audio.play().catch(e => console.log("Audio play failed interaction needed")); 
            btn.classList.add("music-anim"); 
        }
        isPlaying = !isPlaying;
      }

      document.getElementById("heart-btn").addEventListener("click", (e) => {
        const rect = e.target.getBoundingClientRect();
        const x = rect.left + rect.width/2;
        const y = rect.top + rect.height/2;
        
        anime({ targets: '#heart-btn', scale: [1, 1.4, 1], duration: 300, easing: 'easeInOutQuad' });

        const count = isMobile ? 15 : 30; 
        for(let i=0; i<count; i++) {
            const p = document.createElement("div");
            p.className = "particle";
            p.style.left = x + "px"; p.style.top = y + "px";
            document.body.appendChild(p);
            
            const angle = Math.random() * Math.PI * 2;
            const velocity = Math.random() * 100 + 50;
            
            anime({
                targets: p,
                translateX: Math.cos(angle) * velocity,
                translateY: Math.sin(angle) * velocity,
                opacity: [1, 0],
                scale: [0, 1.5],
                duration: Math.random() * 800 + 600,
                easing: 'easeOutExpo',
                complete: () => p.remove()
            });
        }
      });
    </script>
  </body>
</html>